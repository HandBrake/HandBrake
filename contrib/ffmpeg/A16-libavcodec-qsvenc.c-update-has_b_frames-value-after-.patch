From 82a75013402293f86fca38a8ffc1b3c7fe6d8b0e Mon Sep 17 00:00:00 2001
From: galinart <artem.galin@intel.com>
Date: Thu, 17 Oct 2024 16:17:36 +0100
Subject: [PATCH 16/22] libavcodec/qsvenc.c: update has_b_frames value after
 initialization of encoder

---
 libavcodec/qsvenc.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/libavcodec/qsvenc.c b/libavcodec/qsvenc.c
index 318a99e2a1..039a108aae 100644
--- a/libavcodec/qsvenc.c
+++ b/libavcodec/qsvenc.c
@@ -1842,6 +1842,13 @@ int ff_qsv_enc_init(AVCodecContext *avctx, QSVEncContext *q)
         return ret;
     }
 
+    // Update AVCodecContext with actual encoding parameters
+    mfxInfoMFX *info = &q->param.mfx;
+    avctx->has_b_frames = 0;
+    if (info->GopRefDist > 1) {
+        avctx->has_b_frames = info->GopRefDist - 1;
+    }
+
     q->avctx = avctx;
 
     return 0;
-- 
2.39.5 (Apple Git-154)

